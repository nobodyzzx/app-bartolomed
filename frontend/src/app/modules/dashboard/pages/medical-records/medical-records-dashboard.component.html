<div class="min-h-screen bg-slate-50 p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Aviso de Modo DEMO -->
    <div *ngIf="isDemo" class="mb-10">
      <div
        class="bg-amber-50 border-l-4 border-amber-500 p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow"
      >
        <div class="flex items-start gap-4">
          <div
            class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0"
          >
            <mat-icon class="!text-[24px] text-amber-600">info</mat-icon>
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-amber-900 text-lg mb-2">Modo DEMO activo</h3>
            <p class="text-sm text-amber-800 leading-relaxed">
              No se realizarán llamadas al backend. Algunas acciones como crear, editar o eliminar
              están deshabilitadas.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between mb-10">
      <div class="flex items-center gap-4">
        <button
          type="button"
          (click)="goBack()"
          class="inline-flex items-center justify-center w-11 h-11 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 shadow-md hover:shadow-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-200 focus-visible:ring-offset-1 transition-all border-0"
          matTooltip="Volver"
          aria-label="Volver"
        >
          <mat-icon class="!text-[20px] leading-none">arrow_back</mat-icon>
        </button>
        <div class="text-left">
          <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-0.5">Expedientes Médicos</h1>
          <p class="text-slate-600">Gestión completa de historiales clínicos</p>
        </div>
      </div>
      <button
        type="button"
        routerLink="new"
        [disabled]="isDemo"
        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full font-medium bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 shadow-md hover:shadow-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-200 focus-visible:ring-offset-1 transition-all disabled:opacity-60 disabled:cursor-not-allowed border-0"
        matTooltip="Inicia sesión para crear expedientes"
        [matTooltipDisabled]="!isDemo"
        aria-label="Crear nuevo expediente"
      >
        <mat-icon class="!text-[20px] leading-none">add</mat-icon>
        Nuevo Expediente
      </button>
    </div>

    <!-- Estadísticas -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      <!-- Total Expedientes -->
      <div
        class="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-500 shadow-md hover:shadow-lg transition-shadow cursor-pointer"
        (click)="showAllRecords()"
      >
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-600 text-sm font-semibold">Total Expedientes</p>
            <p class="text-3xl font-bold text-blue-900 mt-2">{{ stats.total }}</p>
            <p class="text-xs text-blue-600/60 mt-1">Registros en el sistema</p>
          </div>
          <mat-icon class="text-blue-500 !text-[40px] !w-10 !h-10">folder_shared</mat-icon>
        </div>
      </div>

      <!-- Borradores -->
      <div
        class="bg-orange-50 p-4 rounded-xl border-l-4 border-orange-500 shadow-md hover:shadow-lg transition-shadow cursor-pointer"
        (click)="showDrafts()"
      >
        <div class="flex items-center justify-between">
          <div>
            <p class="text-orange-600 text-sm font-semibold">Borradores</p>
            <p class="text-3xl font-bold text-orange-900 mt-2">{{ stats.drafts }}</p>
            <p class="text-xs text-orange-600/60 mt-1">Pendientes de completar</p>
          </div>
          <mat-icon class="text-orange-500 !text-[40px] !w-10 !h-10">edit_note</mat-icon>
        </div>
      </div>

      <!-- Completados -->
      <div
        class="bg-green-50 p-4 rounded-xl border-l-4 border-green-500 shadow-md hover:shadow-lg transition-shadow cursor-pointer"
        (click)="showCompleted()"
      >
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-600 text-sm font-semibold">Completados</p>
            <p class="text-3xl font-bold text-green-900 mt-2">{{ stats.completed }}</p>
            <p class="text-xs text-green-600/60 mt-1">Expedientes finalizados</p>
          </div>
          <mat-icon class="text-green-500 !text-[40px] !w-10 !h-10">check_circle</mat-icon>
        </div>
      </div>

      <!-- Emergencias -->
      <div
        class="bg-red-50 p-4 rounded-xl border-l-4 border-red-500 shadow-md hover:shadow-lg transition-shadow cursor-pointer"
        (click)="showEmergencies()"
      >
        <div class="flex items-center justify-between">
          <div>
            <p class="text-red-600 text-sm font-semibold">Emergencias</p>
            <p class="text-3xl font-bold text-red-900 mt-2">{{ stats.emergencies }}</p>
            <p class="text-xs text-red-600/60 mt-1">Atención prioritaria</p>
          </div>
          <mat-icon class="text-red-500 !text-[40px] !w-10 !h-10">emergency</mat-icon>
        </div>
      </div>
    </div>

    <!-- Búsqueda y Acciones -->
    <div class="flex items-center gap-4 mb-6">
      <div class="flex-1 max-w-2xl">
        <div class="relative">
          <input
            type="text"
            (keyup)="applyFilter($event)"
            placeholder="Paciente, diagnóstico, doctor..."
            class="w-full h-11 rounded-full bg-blue-50 px-5 pr-12 text-slate-900 placeholder-blue-400/70 shadow-md hover:bg-blue-100 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-200 focus:ring-offset-1 focus:bg-white transition border-0"
          />
          <mat-icon class="absolute right-3 top-2.5 text-blue-400">search</mat-icon>
        </div>
      </div>

      <button
        type="button"
        class="inline-flex items-center gap-2 px-5 h-11 rounded-full font-medium bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 shadow-md hover:shadow-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-200 focus-visible:ring-offset-1 transition-all border-0"
      >
        <mat-icon class="!text-[18px]">search</mat-icon>
        Buscar
      </button>

      <div class="flex-1"></div>

      <button
        type="button"
        [disabled]="isDemo"
        class="inline-flex items-center gap-2 px-5 h-11 rounded-full font-medium bg-slate-50 text-slate-700 hover:bg-slate-100 hover:text-slate-900 shadow-md hover:shadow-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-200 focus-visible:ring-offset-1 transition-all disabled:opacity-60 disabled:cursor-not-allowed border-0"
        matTooltip="Inicia sesión para exportar"
        [matTooltipDisabled]="!isDemo"
      >
        <mat-icon class="!text-[18px]">download</mat-icon>
        Exportar
      </button>
    </div>

    <!-- Tabla de Expedientes -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
      <div class="overflow-x-auto">
        <table mat-table [dataSource]="dataSource" matSort class="w-full bg-transparent">
          <!-- Columna Fecha -->
          <ng-container matColumnDef="date">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="bg-slate-100 text-slate-800 font-semibold p-4 text-left"
            >
              <div class="flex items-center gap-2">
                <mat-icon class="text-blue-600 !text-[18px]">schedule</mat-icon>
                Fecha
              </div>
            </th>
            <td mat-cell *matCellDef="let record" class="p-4">
              <div class="flex flex-col">
                <span class="font-medium text-slate-900">{{
                  record.createdAt | date: 'short'
                }}</span>
                <span
                  class="text-xs text-red-600 font-semibold flex items-center gap-1 mt-1"
                  *ngIf="record.isEmergency"
                >
                  <mat-icon class="!text-[14px]">emergency</mat-icon>
                  EMERGENCIA
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Columna Paciente -->
          <ng-container matColumnDef="patient">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="bg-slate-100 text-slate-800 font-semibold p-4 text-left"
            >
              <div class="flex items-center gap-2">
                <mat-icon class="text-blue-600 !text-[18px]">person</mat-icon>
                Paciente
              </div>
            </th>
            <td mat-cell *matCellDef="let record" class="p-4">
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0"
                >
                  <mat-icon class="text-blue-600 !text-[20px]">person</mat-icon>
                </div>
                <div>
                  <div class="font-medium text-slate-900">
                    {{ record.patient?.firstName }} {{ record.patient?.lastName }}
                  </div>
                  <div class="text-sm text-slate-600">{{ record.patient?.documentNumber }}</div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Columna Tipo -->
          <ng-container matColumnDef="type">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="bg-slate-100 text-slate-800 font-semibold p-4 text-left"
            >
              <div class="flex items-center gap-2">
                <mat-icon class="text-blue-600 !text-[18px]">category</mat-icon>
                Tipo
              </div>
            </th>
            <td mat-cell *matCellDef="let record" class="p-4">
              <div class="flex items-center gap-2">
                <mat-icon class="text-blue-600 !text-[18px]">{{
                  getRecordIcon(record.type)
                }}</mat-icon>
                <span class="text-slate-600">{{ getTypeText(record.type) }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna Motivo de Consulta -->
          <ng-container matColumnDef="chiefComplaint">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="bg-slate-100 text-slate-800 font-semibold p-4 text-left"
            >
              <div class="flex items-center gap-2">
                <mat-icon class="text-blue-600 !text-[18px]">description</mat-icon>
                Motivo de Consulta
              </div>
            </th>
            <td mat-cell *matCellDef="let record" class="p-4">
              <span class="max-w-xs truncate block text-slate-600" [title]="record.chiefComplaint">
                {{ record.chiefComplaint }}
              </span>
            </td>
          </ng-container>

          <!-- Columna Doctor -->
          <ng-container matColumnDef="doctor">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="bg-slate-100 text-slate-800 font-semibold p-4 text-left"
            >
              <div class="flex items-center gap-2">
                <mat-icon class="text-blue-600 !text-[18px]">medical_services</mat-icon>
                Doctor
              </div>
            </th>
            <td mat-cell *matCellDef="let record" class="p-4">
              <div class="flex flex-col">
                <span class="font-medium text-slate-900">
                  Dr. {{ record.doctor?.firstName }} {{ record.doctor?.lastName }}
                </span>
                <span class="text-sm text-slate-600" *ngIf="record.doctor?.specialization">
                  {{ record.doctor?.specialization }}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Columna Estado -->
          <ng-container matColumnDef="status">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="bg-slate-100 text-slate-800 font-semibold p-4 text-left"
            >
              <div class="flex items-center gap-2">
                <mat-icon class="text-blue-600 !text-[18px]">flag</mat-icon>
                Estado
              </div>
            </th>
            <td mat-cell *matCellDef="let record" class="p-4">
              <span
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium border"
                [ngClass]="{
                  'bg-orange-100 text-orange-800 border-orange-200': record.status === 'draft',
                  'bg-green-100 text-green-800 border-green-200': record.status === 'completed',
                  'bg-blue-100 text-blue-800 border-blue-200': record.status === 'reviewed',
                  'bg-slate-100 text-slate-800 border-slate-200': record.status === 'archived',
                }"
              >
                <span
                  class="w-2 h-2 rounded-full"
                  [ngClass]="{
                    'bg-orange-500': record.status === 'draft',
                    'bg-green-500': record.status === 'completed',
                    'bg-blue-500': record.status === 'reviewed',
                    'bg-slate-500': record.status === 'archived',
                  }"
                ></span>
                {{ getStatusText(record.status) }}
              </span>
            </td>
          </ng-container>

          <!-- Columna Acciones -->
          <ng-container matColumnDef="actions">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="bg-slate-100 text-slate-800 font-semibold p-4 text-left"
            >
              <div class="flex items-center gap-2">
                <mat-icon class="text-blue-600 !text-[18px]">settings</mat-icon>
                Acciones
              </div>
            </th>
            <td mat-cell *matCellDef="let record" class="p-4">
              <div class="flex gap-2 items-center">
                <button
                  mat-icon-button
                  class="w-9 h-9 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-blue-200"
                  (click)="viewRecord(record)"
                  matTooltip="Ver expediente"
                  aria-label="Ver expediente"
                >
                  <mat-icon class="!text-[20px] leading-none">visibility</mat-icon>
                </button>

                <button
                  mat-icon-button
                  class="w-9 h-9 text-amber-600 hover:bg-amber-50 rounded-lg transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-amber-200"
                  (click)="editRecord(record)"
                  matTooltip="Editar expediente"
                  aria-label="Editar expediente"
                  [disabled]="record.status === 'archived' || isDemo"
                >
                  <mat-icon class="!text-[20px] leading-none">edit</mat-icon>
                </button>

                <button
                  mat-icon-button
                  class="w-9 h-9 text-red-600 hover:bg-red-50 rounded-lg transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-red-200"
                  (click)="deleteRecord(record)"
                  matTooltip="Eliminar expediente"
                  aria-label="Eliminar expediente"
                  [disabled]="isDemo"
                >
                  <mat-icon class="!text-[20px] leading-none">delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr
            mat-header-row
            *matHeaderRowDef="displayedColumns"
            class="border-b-2 border-slate-200"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            class="border-b border-slate-100 hover:bg-slate-50 transition-colors"
          ></tr>
        </table>
      </div>

      <!-- Indicador de carga -->
      <div *ngIf="loading" class="flex justify-center items-center py-12">
        <mat-spinner diameter="50"></mat-spinner>
      </div>

      <!-- Mensaje cuando no hay datos -->
      <div *ngIf="!loading && dataSource.data.length === 0" class="text-center py-12 px-6">
        <mat-icon class="text-6xl text-slate-400 mb-4">folder_open</mat-icon>
        <p class="text-slate-500 text-lg mb-4">No se encontraron expedientes médicos</p>
        <button
          type="button"
          (click)="createNewRecord()"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full font-medium bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 shadow-md hover:shadow-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-200 focus-visible:ring-offset-1 transition-all border-0"
        >
          <mat-icon class="!text-[20px] leading-none">add</mat-icon>
          Crear primer expediente
        </button>
      </div>

      <!-- Paginador -->
      <mat-paginator
        [pageSizeOptions]="[10, 25, 50, 100]"
        showFirstLastButtons
        aria-label="Seleccionar página de expedientes"
        class="bg-slate-50 border-t border-slate-200"
      ></mat-paginator>
    </div>

    <!-- Contador de resultados -->
    <div class="mt-6 text-center text-slate-600" *ngIf="!loading">
      <p *ngIf="dataSource.data.length > 0" class="text-sm">
        Mostrando {{ dataSource.data.length }} expedientes en total
      </p>
    </div>
  </div>
</div>
