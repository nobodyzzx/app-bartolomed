<div class="medical-record-view-container" *ngIf="medicalRecord">
  <!-- Encabezado -->
  <div class="header-section">
    <div class="flex justify-between items-start mb-6">
      <div>
        <button mat-icon-button (click)="goBack()" class="mb-2">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <h1 class="text-3xl font-bold text-blue-900">Expediente Médico</h1>
        <p class="text-gray-600 mt-2">
          {{medicalRecord.patient?.firstName}} {{medicalRecord.patient?.lastName}} - 
          {{medicalRecord.patient?.documentNumber}}
        </p>
      </div>
      
      <div class="flex gap-2">
        <button mat-raised-button color="accent" (click)="editRecord()" 
                [disabled]="medicalRecord.status === 'archived'">
          <mat-icon>edit</mat-icon>
          Editar
        </button>
        <button mat-raised-button color="primary" (click)="exportRecord()">
          <mat-icon>download</mat-icon>
          Exportar PDF
        </button>
      </div>
    </div>

    <!-- Información básica -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-blue-50 p-4 rounded-lg">
        <p class="text-blue-600 text-sm font-medium">Fecha de Registro</p>
        <p class="text-xl font-bold text-blue-900">{{medicalRecord.createdAt | date:'short'}}</p>
      </div>
      
      <div class="bg-green-50 p-4 rounded-lg">
        <p class="text-green-600 text-sm font-medium">Tipo de Registro</p>
        <p class="text-xl font-bold text-green-900">{{getTypeText(medicalRecord.type)}}</p>
      </div>
      
      <div class="bg-purple-50 p-4 rounded-lg">
        <p class="text-purple-600 text-sm font-medium">Estado</p>
        <mat-chip [color]="getStatusColor(medicalRecord.status)" class="font-bold">
          {{getStatusText(medicalRecord.status)}}
        </mat-chip>
      </div>
      
      <div class="bg-orange-50 p-4 rounded-lg" *ngIf="medicalRecord.isEmergency">
        <p class="text-orange-600 text-sm font-medium">Prioridad</p>
        <p class="text-xl font-bold text-red-600 flex items-center gap-2">
          <mat-icon>emergency</mat-icon>
          EMERGENCIA
        </p>
      </div>
    </div>
  </div>

  <div class="content-grid">
    <!-- Historia Clínica -->
    <mat-card class="mb-6">
      <mat-card-header>
        <mat-card-title>Historia Clínica</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          <div *ngIf="medicalRecord.chiefComplaint">
            <h4 class="font-semibold text-gray-800 mb-2">Motivo de Consulta</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded">{{medicalRecord.chiefComplaint}}</p>
          </div>

          <div *ngIf="medicalRecord.doctor">
            <h4 class="font-semibold text-gray-800 mb-2">Médico Tratante</h4>
            <p class="text-gray-600">
              Dr. {{medicalRecord.doctor.firstName}} {{medicalRecord.doctor.lastName}}
              <span *ngIf="medicalRecord.doctor.specialization" class="block text-sm text-gray-500">
                {{medicalRecord.doctor.specialization}}
              </span>
            </p>
          </div>

          <div *ngIf="medicalRecord.historyOfPresentIllness" class="md:col-span-2">
            <h4 class="font-semibold text-gray-800 mb-2">Historia de la Enfermedad Actual</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.historyOfPresentIllness}}</p>
          </div>

          <div *ngIf="medicalRecord.pastMedicalHistory">
            <h4 class="font-semibold text-gray-800 mb-2">Antecedentes Médicos</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.pastMedicalHistory}}</p>
          </div>

          <div *ngIf="medicalRecord.medications">
            <h4 class="font-semibold text-gray-800 mb-2">Medicamentos Actuales</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.medications}}</p>
          </div>

          <div *ngIf="medicalRecord.allergies">
            <h4 class="font-semibold text-gray-800 mb-2">Alergias</h4>
            <p class="text-gray-600 bg-red-50 p-3 rounded whitespace-pre-wrap border-l-4 border-red-400">{{medicalRecord.allergies}}</p>
          </div>

          <div *ngIf="medicalRecord.familyHistory">
            <h4 class="font-semibold text-gray-800 mb-2">Antecedentes Familiares</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.familyHistory}}</p>
          </div>

          <div *ngIf="medicalRecord.socialHistory">
            <h4 class="font-semibold text-gray-800 mb-2">Historia Social</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.socialHistory}}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Signos Vitales -->
    <mat-card class="mb-6" *ngIf="medicalRecord.vitalSigns">
      <mat-card-header>
        <mat-card-title>Signos Vitales</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
          
          <div *ngIf="medicalRecord.vitalSigns.temperature" class="bg-blue-50 p-3 rounded text-center">
            <p class="text-blue-600 text-sm font-medium">Temperatura</p>
            <p class="text-xl font-bold text-blue-900">{{medicalRecord.vitalSigns.temperature}}°C</p>
          </div>

          <div *ngIf="medicalRecord.vitalSigns.systolicBP && medicalRecord.vitalSigns.diastolicBP" 
               class="bg-red-50 p-3 rounded text-center">
            <p class="text-red-600 text-sm font-medium">Presión Arterial</p>
            <p class="text-xl font-bold text-red-900">
              {{medicalRecord.vitalSigns.systolicBP}}/{{medicalRecord.vitalSigns.diastolicBP}}
            </p>
          </div>

          <div *ngIf="medicalRecord.vitalSigns.heartRate" class="bg-purple-50 p-3 rounded text-center">
            <p class="text-purple-600 text-sm font-medium">Freq. Cardíaca</p>
            <p class="text-xl font-bold text-purple-900">{{medicalRecord.vitalSigns.heartRate}} bpm</p>
          </div>

          <div *ngIf="medicalRecord.vitalSigns.respiratoryRate" class="bg-green-50 p-3 rounded text-center">
            <p class="text-green-600 text-sm font-medium">Freq. Respiratoria</p>
            <p class="text-xl font-bold text-green-900">{{medicalRecord.vitalSigns.respiratoryRate}} rpm</p>
          </div>

          <div *ngIf="medicalRecord.vitalSigns.oxygenSaturation" class="bg-cyan-50 p-3 rounded text-center">
            <p class="text-cyan-600 text-sm font-medium">Saturación O₂</p>
            <p class="text-xl font-bold text-cyan-900">{{medicalRecord.vitalSigns.oxygenSaturation}}%</p>
          </div>

          <div *ngIf="medicalRecord.vitalSigns.weight && medicalRecord.vitalSigns.height" 
               class="bg-orange-50 p-3 rounded text-center">
            <p class="text-orange-600 text-sm font-medium">IMC</p>
            <p class="text-xl font-bold text-orange-900">
              {{calculateBMI(medicalRecord.vitalSigns.weight, medicalRecord.vitalSigns.height) | number:'1.1-1'}}
            </p>
            <p class="text-xs text-orange-600">
              {{getBMICategory(calculateBMI(medicalRecord.vitalSigns.weight, medicalRecord.vitalSigns.height)!)}}
            </p>
          </div>

          <div *ngIf="medicalRecord.vitalSigns.weight" class="bg-gray-50 p-3 rounded text-center">
            <p class="text-gray-600 text-sm font-medium">Peso</p>
            <p class="text-xl font-bold text-gray-900">{{medicalRecord.vitalSigns.weight}} kg</p>
          </div>

          <div *ngIf="medicalRecord.vitalSigns.height" class="bg-gray-50 p-3 rounded text-center">
            <p class="text-gray-600 text-sm font-medium">Altura</p>
            <p class="text-xl font-bold text-gray-900">{{medicalRecord.vitalSigns.height}} cm</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Examen Físico -->
    <mat-card class="mb-6" *ngIf="medicalRecord.physicalExam || medicalRecord.physicalExamination">
      <mat-card-header>
        <mat-card-title>Examen Físico</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          <div *ngIf="medicalRecord.physicalExam?.generalAppearance">
            <h4 class="font-semibold text-gray-800 mb-2">Apariencia General</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.physicalExam.generalAppearance}}</p>
          </div>

          <div *ngIf="medicalRecord.physicalExam?.heent">
            <h4 class="font-semibold text-gray-800 mb-2">Cabeza, Ojos, Oídos, Nariz, Garganta</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.physicalExam.heent}}</p>
          </div>

          <div *ngIf="medicalRecord.physicalExam?.cardiovascular">
            <h4 class="font-semibold text-gray-800 mb-2">Sistema Cardiovascular</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.physicalExam.cardiovascular}}</p>
          </div>

          <div *ngIf="medicalRecord.physicalExam?.respiratory">
            <h4 class="font-semibold text-gray-800 mb-2">Sistema Respiratorio</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.physicalExam.respiratory}}</p>
          </div>

          <div *ngIf="medicalRecord.physicalExam?.abdominal">
            <h4 class="font-semibold text-gray-800 mb-2">Abdomen</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.physicalExam.abdominal}}</p>
          </div>

          <div *ngIf="medicalRecord.physicalExam?.neurological">
            <h4 class="font-semibold text-gray-800 mb-2">Sistema Neurológico</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.physicalExam.neurological}}</p>
          </div>

          <div *ngIf="medicalRecord.physicalExam?.musculoskeletal">
            <h4 class="font-semibold text-gray-800 mb-2">Sistema Musculoesquelético</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.physicalExam.musculoskeletal}}</p>
          </div>

          <div *ngIf="medicalRecord.physicalExam?.skin">
            <h4 class="font-semibold text-gray-800 mb-2">Piel</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.physicalExam.skin}}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Evaluación y Plan -->
    <mat-card class="mb-6">
      <mat-card-header>
        <mat-card-title>Evaluación y Plan de Tratamiento</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          <div *ngIf="medicalRecord.diagnosis" class="md:col-span-2">
            <h4 class="font-semibold text-gray-800 mb-2">Diagnóstico Principal</h4>
            <p class="text-gray-600 bg-blue-50 p-3 rounded whitespace-pre-wrap border-l-4 border-blue-400">{{medicalRecord.diagnosis}}</p>
          </div>

          <div *ngIf="medicalRecord.assessment">
            <h4 class="font-semibold text-gray-800 mb-2">Evaluación Clínica</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.assessment}}</p>
          </div>

          <div *ngIf="medicalRecord.plan">
            <h4 class="font-semibold text-gray-800 mb-2">Plan de Tratamiento</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.plan}}</p>
          </div>

          <div *ngIf="medicalRecord.differentialDiagnosis">
            <h4 class="font-semibold text-gray-800 mb-2">Diagnósticos Diferenciales</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.differentialDiagnosis}}</p>
          </div>

          <div *ngIf="medicalRecord.treatmentPlan">
            <h4 class="font-semibold text-gray-800 mb-2">Plan de Tratamiento Detallado</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.treatmentPlan}}</p>
          </div>

          <div *ngIf="medicalRecord.followUpInstructions">
            <h4 class="font-semibold text-gray-800 mb-2">Instrucciones de Seguimiento</h4>
            <p class="text-gray-600 bg-yellow-50 p-3 rounded whitespace-pre-wrap border-l-4 border-yellow-400">{{medicalRecord.followUpInstructions}}</p>
          </div>

          <div *ngIf="medicalRecord.patientEducation">
            <h4 class="font-semibold text-gray-800 mb-2">Educación al Paciente</h4>
            <p class="text-gray-600 bg-green-50 p-3 rounded whitespace-pre-wrap border-l-4 border-green-400">{{medicalRecord.patientEducation}}</p>
          </div>

          <div *ngIf="medicalRecord.followUpDate">
            <h4 class="font-semibold text-gray-800 mb-2">Fecha de Seguimiento</h4>
            <p class="text-gray-600 bg-purple-50 p-3 rounded flex items-center gap-2">
              <mat-icon class="text-purple-600">event</mat-icon>
              {{medicalRecord.followUpDate | date:'fullDate'}}
            </p>
          </div>

          <div *ngIf="medicalRecord.notes" class="md:col-span-2">
            <h4 class="font-semibold text-gray-800 mb-2">Notas Adicionales</h4>
            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">{{medicalRecord.notes}}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Consentimientos Informados -->
    <mat-card class="mb-6" *ngIf="consentForms.length > 0">
      <mat-card-header>
        <mat-card-title>Consentimientos Informados</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="space-y-4">
          <div *ngFor="let consent of consentForms" 
               class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h4 class="font-semibold text-gray-800">{{consent.consentType}}</h4>
                <p class="text-gray-600 mt-2">{{consent.description}}</p>
                <div class="flex items-center gap-4 mt-3 text-sm text-gray-500">
                  <span *ngIf="consent.signedAt">
                    <mat-icon class="text-green-600 text-sm">check_circle</mat-icon>
                    Firmado: {{consent.signedAt | date:'short'}}
                  </span>
                  <span *ngIf="consent.signedBy">
                    Por: {{consent.signedBy}}
                  </span>
                </div>
              </div>
              <div class="flex gap-2">
                <button mat-icon-button 
                        *ngIf="consent.documentPath" 
                        (click)="downloadConsentDocument(consent)"
                        matTooltip="Descargar documento firmado">
                  <mat-icon>download</mat-icon>
                </button>
                <mat-chip [color]="consent.isActive ? 'primary' : 'basic'">
                  {{consent.isActive ? 'Activo' : 'Inactivo'}}
                </mat-chip>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<!-- Loading spinner -->
<div *ngIf="loading" class="flex justify-center items-center py-8">
  <mat-spinner diameter="50"></mat-spinner>
</div>

<!-- Error state -->
<div *ngIf="!loading && !medicalRecord" class="text-center py-8">
  <mat-icon class="text-gray-400 text-6xl mb-4">error_outline</mat-icon>
  <p class="text-gray-500 text-lg">No se pudo cargar el expediente médico</p>
  <button mat-raised-button color="primary" (click)="goBack()" class="mt-4">
    Volver a la lista
  </button>
</div>
