<div class="medical-record-form-container">
  <div class="medical-record-form-content">
    <!-- Bot贸n Volver -->
    <div class="top-actions">
      <button mat-stroked-button color="primary" (click)="goBack()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
        Volver
      </button>
    </div>

    <!-- Encabezado -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-blue-900 mb-4">
        {{ isEditMode ? 'Editar Expediente M茅dico' : 'Nuevo Expediente M茅dico' }}
      </h1>
      <div class="w-24 h-1 bg-blue-600 mx-auto rounded-full mb-4"></div>
      <p class="text-lg text-blue-600">
        {{
          isEditMode
            ? 'Modificar informaci贸n del expediente m茅dico'
            : 'Crear nuevo expediente m茅dico paso a paso'
        }}
      </p>
    </div>

    <!-- Barra de Progreso -->
    <div class="progress-container" *ngIf="!isLoading">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getStepProgress()"></div>
      </div>
      <div class="progress-text">{{ getStepProgress() }}% Completado</div>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="flex justify-center items-center py-8">
      <mat-spinner diameter="50"></mat-spinner>
    </div>

    <!-- Stepper Form -->
    <mat-stepper [linear]="true" #stepper *ngIf="!isLoading" class="custom-stepper">
      <!-- Paso 1: Informaci贸n del Paciente -->
      <mat-step [stepControl]="patientInfoForm">
        <ng-template matStepLabel>
          <div class="step-label">
            <div class="step-icon-badge">
              <mat-icon>person</mat-icon>
            </div>
            <div class="step-text">
              <div class="step-title">Informaci贸n</div>
              <div class="step-subtitle">Paciente y consulta</div>
            </div>
          </div>
        </ng-template>

        <div class="step-header">
          <mat-icon class="step-header-icon">person</mat-icon>
          <div class="step-header-content">
            <h2 class="step-header-title">Informaci贸n del Paciente y Consulta</h2>
            <p class="step-header-description">Datos b谩sicos del paciente y motivo de consulta</p>
          </div>
        </div>

        <form [formGroup]="patientInfoForm">
          <div class="step-content">
            <div class="form-card">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Selecci贸n de Paciente -->
                <mat-form-field appearance="outline">
                  <mat-label>Paciente</mat-label>
                  <mat-select formControlName="patientId" required>
                    <mat-option value="">Seleccione un paciente</mat-option>
                    <mat-option *ngFor="let patient of patients$ | async" [value]="patient.id">
                      {{ patient.firstName }} {{ patient.lastName }} - {{ patient.documentNumber }}
                    </mat-option>
                  </mat-select>
                  <mat-icon matSuffix>person</mat-icon>
                  <mat-error *ngIf="patientInfoForm.get('patientId')?.hasError('required')">
                    Debe seleccionar un paciente
                  </mat-error>
                </mat-form-field>

                <!-- Selecci贸n de Doctor -->
                <mat-form-field appearance="outline">
                  <mat-label>Doctor</mat-label>
                  <mat-select formControlName="doctorId" required>
                    <mat-option value="">Seleccione un doctor</mat-option>
                    <mat-option *ngFor="let doctor of doctors$ | async" [value]="doctor.id">
                      <span *ngIf="doctor.professionalInfo?.title">{{
                        doctor.professionalInfo.title
                      }}</span>
                      {{ doctor.personalInfo?.firstName }} {{ doctor.personalInfo?.lastName }}
                      <span *ngIf="doctor.professionalInfo?.specialization">
                        - {{ doctor.professionalInfo.specialization }}</span
                      >
                    </mat-option>
                  </mat-select>
                  <mat-icon matSuffix>medical_services</mat-icon>
                  <mat-error *ngIf="patientInfoForm.get('doctorId')?.hasError('required')">
                    Debe seleccionar un doctor
                  </mat-error>
                </mat-form-field>

                <!-- Tipo de Registro -->
                <mat-form-field appearance="outline">
                  <mat-label>Tipo de Consulta</mat-label>
                  <mat-select formControlName="type" required>
                    <mat-option *ngFor="let type of recordTypes" [value]="type">
                      {{ getTypeText(type) }}
                    </mat-option>
                  </mat-select>
                  <mat-icon matSuffix>assignment</mat-icon>
                  <mat-error *ngIf="patientInfoForm.get('type')?.hasError('required')">
                    Debe seleccionar el tipo de consulta
                  </mat-error>
                </mat-form-field>

                <!-- Emergencia -->
                <div class="flex items-center">
                  <mat-checkbox formControlName="isEmergency" class="text-red-600">
                    <span class="ml-2 text-red-600 font-medium">Marcar como Emergencia</span>
                  </mat-checkbox>
                </div>

                <!-- Motivo Principal de Consulta -->
                <mat-form-field appearance="outline" class="md:col-span-2">
                  <mat-label>Motivo Principal de Consulta</mat-label>
                  <textarea
                    matInput
                    formControlName="chiefComplaint"
                    placeholder="Describa el motivo principal por el cual el paciente busca atenci贸n m茅dica..."
                    rows="4"
                    required
                  ></textarea>
                  <mat-icon matSuffix>description</mat-icon>
                  <mat-error *ngIf="patientInfoForm.get('chiefComplaint')?.hasError('required')">
                    El motivo de consulta es requerido
                  </mat-error>
                  <mat-error *ngIf="patientInfoForm.get('chiefComplaint')?.hasError('minlength')">
                    Debe proporcionar una descripci贸n m谩s detallada (m铆nimo 10 caracteres)
                  </mat-error>
                </mat-form-field>
              </div>
            </div>

            <!-- Datos de Ejemplo -->
            <div class="mt-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
              <h3 class="text-sm font-bold text-blue-800 mb-2"> Ejemplos para prueba:</h3>
              <div class="text-xs text-blue-700 grid grid-cols-1 md:grid-cols-2 gap-2">
                <div><strong>Paciente:</strong> Cualquier paciente registrado</div>
                <div><strong>Motivo:</strong> "Dolor abdominal de 2 d铆as de evoluci贸n"</div>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button mat-stroked-button (click)="cancel()" type="button">Cancelar</button>
            <button
              mat-flat-button
              color="primary"
              matStepperNext
              [disabled]="patientInfoForm.invalid"
            >
              Siguiente
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Paso 2: Historia M茅dica -->
      <mat-step [stepControl]="medicalHistoryForm">
        <ng-template matStepLabel>
          <div class="step-label">
            <div class="step-icon-badge">
              <mat-icon>history</mat-icon>
            </div>
            <div class="step-text">
              <div class="step-title">Historia</div>
              <div class="step-subtitle">M茅dica del paciente</div>
            </div>
          </div>
        </ng-template>

        <div class="step-header">
          <mat-icon class="step-header-icon">history</mat-icon>
          <div class="step-header-content">
            <h2 class="step-header-title">Historia M茅dica del Paciente</h2>
            <p class="step-header-description">Antecedentes y evoluci贸n de la enfermedad</p>
          </div>
        </div>

        <form [formGroup]="medicalHistoryForm">
          <div class="step-content">
            <div class="form-card">
              <div class="grid grid-cols-1 gap-6">
                <!-- Historia de la Enfermedad Actual -->
                <mat-form-field appearance="outline">
                  <mat-label>Historia de la Enfermedad Actual</mat-label>
                  <textarea
                    matInput
                    formControlName="historyOfPresentIllness"
                    placeholder="Describa la evoluci贸n detallada de los s铆ntomas actuales..."
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <!-- Antecedentes M茅dicos -->
                <mat-form-field appearance="outline">
                  <mat-label>Antecedentes M茅dicos</mat-label>
                  <textarea
                    matInput
                    formControlName="pastMedicalHistory"
                    placeholder="Enfermedades previas, cirug铆as, hospitalizaciones..."
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <!-- Medicamentos Actuales -->
                <mat-form-field appearance="outline">
                  <mat-label>Medicamentos Actuales</mat-label>
                  <textarea
                    matInput
                    formControlName="medications"
                    placeholder="Lista de medicamentos que toma actualmente, dosis y frecuencia..."
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <!-- Alergias -->
                <mat-form-field appearance="outline">
                  <mat-label>Alergias</mat-label>
                  <textarea
                    matInput
                    formControlName="allergies"
                    placeholder="Alergias conocidas a medicamentos, alimentos, etc..."
                    rows="2"
                  ></textarea>
                </mat-form-field>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Historia Social -->
                  <mat-form-field appearance="outline">
                    <mat-label>Historia Social</mat-label>
                    <textarea
                      matInput
                      formControlName="socialHistory"
                      placeholder="H谩bitos, ocupaci贸n, estilo de vida..."
                      rows="3"
                    ></textarea>
                  </mat-form-field>

                  <!-- Historia Familiar -->
                  <mat-form-field appearance="outline">
                    <mat-label>Historia Familiar</mat-label>
                    <textarea
                      matInput
                      formControlName="familyHistory"
                      placeholder="Enfermedades en familiares cercanos..."
                      rows="3"
                    ></textarea>
                  </mat-form-field>
                </div>

                <!-- Revisi贸n por Sistemas -->
                <mat-form-field appearance="outline">
                  <mat-label>Revisi贸n por Sistemas</mat-label>
                  <textarea
                    matInput
                    formControlName="reviewOfSystems"
                    placeholder="S铆ntomas por sistemas (cardiovascular, respiratorio, etc.)..."
                    rows="3"
                  ></textarea>
                </mat-form-field>
              </div>

              <!-- Ejemplos para Historia M茅dica -->
              <div class="mt-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                <h3 class="text-sm font-bold text-green-800 mb-2">
                   Ejemplos para Historia M茅dica:
                </h3>
                <div class="text-xs text-green-700 space-y-1">
                  <div>
                    <strong>Enfermedad Actual:</strong> "Dolor abdominal iniciado hace 2 d铆as, tipo
                    c贸lico, localizado en fosa il铆aca derecha"
                  </div>
                  <div>
                    <strong>Antecedentes:</strong> "Hipertensi贸n arterial desde hace 5 a帽os,
                    controlada con medicamento"
                  </div>
                  <div>
                    <strong>Medicamentos:</strong> "Losart谩n 50mg cada 12 horas, Metformina 500mg
                    con desayuno y cena"
                  </div>
                  <div>
                    <strong>Alergias:</strong> "Alergia conocida a Penicilina (rash cut谩neo)"
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button mat-stroked-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Anterior
            </button>
            <div class="flex gap-2">
              <button mat-stroked-button (click)="saveDraft()" type="button" color="accent">
                <mat-icon>save</mat-icon>
                Guardar Borrador
              </button>
              <button mat-flat-button color="primary" matStepperNext>
                Siguiente
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </div>
        </form>
      </mat-step>

      <!-- Paso 3: Signos Vitales -->
      <mat-step [stepControl]="vitalSignsForm" label="Signos Vitales">
        <form [formGroup]="vitalSignsForm">
          <div class="bg-white p-8 rounded-2xl shadow-lg border border-blue-100 mb-6">
            <h2 class="text-2xl font-bold text-blue-900 mb-6 flex items-center gap-3">
              <mat-icon class="text-blue-600">monitor_heart</mat-icon>
              Signos Vitales
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
              <!-- Temperatura -->
              <mat-form-field appearance="outline">
                <mat-label>Temperatura (掳C)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="temperature"
                  placeholder="36.5"
                  step="0.1"
                  min="30"
                  max="45"
                />
                <mat-icon matSuffix>thermostat</mat-icon>
              </mat-form-field>

              <!-- Presi贸n Arterial Sist贸lica -->
              <mat-form-field appearance="outline">
                <mat-label>P.A. Sist贸lica (mmHg)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="systolicBP"
                  placeholder="120"
                  min="50"
                  max="300"
                />
                <mat-icon matSuffix>favorite</mat-icon>
              </mat-form-field>

              <!-- Presi贸n Arterial Diast贸lica -->
              <mat-form-field appearance="outline">
                <mat-label>P.A. Diast贸lica (mmHg)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="diastolicBP"
                  placeholder="80"
                  min="30"
                  max="200"
                />
                <mat-icon matSuffix>favorite</mat-icon>
              </mat-form-field>

              <!-- Frecuencia Card铆aca -->
              <mat-form-field appearance="outline">
                <mat-label>Frecuencia Card铆aca (lpm)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="heartRate"
                  placeholder="72"
                  min="30"
                  max="200"
                />
                <mat-icon matSuffix>monitor_heart</mat-icon>
              </mat-form-field>

              <!-- Frecuencia Respiratoria -->
              <mat-form-field appearance="outline">
                <mat-label>Freq. Respiratoria (rpm)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="respiratoryRate"
                  placeholder="16"
                  min="5"
                  max="60"
                />
                <mat-icon matSuffix>air</mat-icon>
              </mat-form-field>

              <!-- Saturaci贸n de Ox铆geno -->
              <mat-form-field appearance="outline">
                <mat-label>Sat. Ox铆geno (%)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="oxygenSaturation"
                  placeholder="98"
                  min="50"
                  max="100"
                />
                <mat-icon matSuffix>sensors</mat-icon>
              </mat-form-field>

              <!-- Peso -->
              <mat-form-field appearance="outline">
                <mat-label>Peso (kg)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="weight"
                  placeholder="70"
                  step="0.1"
                  min="1"
                  max="500"
                />
                <mat-icon matSuffix>scale</mat-icon>
              </mat-form-field>

              <!-- Altura -->
              <mat-form-field appearance="outline">
                <mat-label>Altura (cm)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="height"
                  placeholder="170"
                  min="50"
                  max="250"
                />
                <mat-icon matSuffix>height</mat-icon>
              </mat-form-field>
            </div>

            <!-- Ejemplos para Signos Vitales -->
            <div class="mt-6 p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
              <h3 class="text-sm font-bold text-purple-800 mb-2">
                 Valores Normales de Referencia:
              </h3>
              <div class="text-xs text-purple-700 grid grid-cols-2 md:grid-cols-4 gap-2">
                <div><strong>Temperatura:</strong> 36.1-37.2掳C</div>
                <div><strong>P.A.:</strong> 120/80 mmHg</div>
                <div><strong>F.C.:</strong> 60-100 lpm</div>
                <div><strong>F.R.:</strong> 12-20 rpm</div>
                <div><strong>Sat O2:</strong> >95%</div>
                <div><strong>Peso:</strong> Variable</div>
                <div><strong>Altura:</strong> Variable</div>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button mat-stroked-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Anterior
            </button>
            <div class="flex gap-2">
              <button mat-stroked-button (click)="saveDraft()" type="button" color="accent">
                <mat-icon>save</mat-icon>
                Guardar Borrador
              </button>
              <button mat-flat-button color="primary" matStepperNext>
                Siguiente
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </div>
        </form>
      </mat-step>

      <!-- Paso 4: Examen F铆sico -->
      <mat-step [stepControl]="physicalExamForm" label="Examen F铆sico">
        <form [formGroup]="physicalExamForm">
          <div class="bg-white p-8 rounded-2xl shadow-lg border border-blue-100 mb-6">
            <h2 class="text-2xl font-bold text-blue-900 mb-6 flex items-center gap-3">
              <mat-icon class="text-blue-600">healing</mat-icon>
              Examen F铆sico
            </h2>

            <div class="grid grid-cols-1 gap-6">
              <!-- Examen F铆sico General -->
              <mat-form-field appearance="outline">
                <mat-label>Resumen del Examen F铆sico</mat-label>
                <textarea
                  matInput
                  formControlName="physicalExamination"
                  placeholder="Resumen general de los hallazgos del examen f铆sico..."
                  rows="3"
                ></textarea>
              </mat-form-field>

              <!-- Apariencia General -->
              <mat-form-field appearance="outline">
                <mat-label>Apariencia General</mat-label>
                <textarea
                  matInput
                  formControlName="generalAppearance"
                  placeholder="Estado general, nivel de conciencia, cooperaci贸n..."
                  rows="2"
                ></textarea>
              </mat-form-field>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cabeza, Ojos, O铆dos, Nariz, Garganta -->
                <mat-form-field appearance="outline">
                  <mat-label>Cabeza, Ojos, O铆dos, Nariz, Garganta</mat-label>
                  <textarea
                    matInput
                    formControlName="heent"
                    placeholder="Hallazgos en HEENT..."
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <!-- Cardiovascular -->
                <mat-form-field appearance="outline">
                  <mat-label>Sistema Cardiovascular</mat-label>
                  <textarea
                    matInput
                    formControlName="cardiovascular"
                    placeholder="Ruidos card铆acos, soplos, pulsos..."
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <!-- Respiratorio -->
                <mat-form-field appearance="outline">
                  <mat-label>Sistema Respiratorio</mat-label>
                  <textarea
                    matInput
                    formControlName="respiratory"
                    placeholder="Ruidos respiratorios, expansi贸n tor谩cica..."
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <!-- Abdominal -->
                <mat-form-field appearance="outline">
                  <mat-label>Examen Abdominal</mat-label>
                  <textarea
                    matInput
                    formControlName="abdominal"
                    placeholder="Inspecci贸n, palpaci贸n, percusi贸n, auscultaci贸n..."
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <!-- Neurol贸gico -->
                <mat-form-field appearance="outline">
                  <mat-label>Examen Neurol贸gico</mat-label>
                  <textarea
                    matInput
                    formControlName="neurological"
                    placeholder="Funci贸n mental, reflejos, funci贸n motora..."
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <!-- Musculoesquel茅tico -->
                <mat-form-field appearance="outline">
                  <mat-label>Sistema Musculoesquel茅tico</mat-label>
                  <textarea
                    matInput
                    formControlName="musculoskeletal"
                    placeholder="Movilidad, fuerza, deformidades..."
                    rows="3"
                  ></textarea>
                </mat-form-field>
              </div>

              <!-- Piel -->
              <mat-form-field appearance="outline">
                <mat-label>Examen de la Piel</mat-label>
                <textarea
                  matInput
                  formControlName="skin"
                  placeholder="Color, temperatura, humedad, lesiones..."
                  rows="2"
                ></textarea>
              </mat-form-field>
            </div>

            <!-- Ejemplos para Examen F铆sico -->
            <div class="mt-6 p-4 bg-teal-50 rounded-lg border-l-4 border-teal-500">
              <h3 class="text-sm font-bold text-teal-800 mb-2"> Ejemplos de Examen F铆sico:</h3>
              <div class="text-xs text-teal-700 space-y-1">
                <div>
                  <strong>Apariencia:</strong> "Paciente consciente, orientado, colaborador, en
                  posici贸n anti谩lgica"
                </div>
                <div>
                  <strong>Cardiovascular:</strong> "Ruidos card铆acos r铆tmicos, no soplos, pulsos
                  perif茅ricos palpables"
                </div>
                <div>
                  <strong>Abdominal:</strong> "Abdomen blando, depresible, doloroso a la palpaci贸n
                  en fosa il铆aca derecha"
                </div>
                <div>
                  <strong>Neurol贸gico:</strong> "Funciones mentales superiores conservadas, reflejos
                  normales"
                </div>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button mat-stroked-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Anterior
            </button>
            <div class="flex gap-2">
              <button mat-stroked-button (click)="saveDraft()" type="button" color="accent">
                <mat-icon>save</mat-icon>
                Guardar Borrador
              </button>
              <button mat-flat-button color="primary" matStepperNext>
                Siguiente
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </div>
        </form>
      </mat-step>

      <!-- Paso 5: Evaluaci贸n y Plan -->
      <mat-step [stepControl]="assessmentForm" label="Evaluaci贸n y Plan">
        <form [formGroup]="assessmentForm">
          <div class="bg-white p-8 rounded-2xl shadow-lg border border-blue-100 mb-6">
            <h2 class="text-2xl font-bold text-blue-900 mb-6 flex items-center gap-3">
              <mat-icon class="text-blue-600">assessment</mat-icon>
              Evaluaci贸n y Plan de Tratamiento
            </h2>

            <div class="grid grid-cols-1 gap-6">
              <!-- Evaluaci贸n Cl铆nica -->
              <mat-form-field appearance="outline">
                <mat-label>Evaluaci贸n Cl铆nica</mat-label>
                <textarea
                  matInput
                  formControlName="assessment"
                  placeholder="An谩lisis de hallazgos y impresi贸n cl铆nica..."
                  rows="3"
                ></textarea>
              </mat-form-field>

              <!-- Plan General -->
              <mat-form-field appearance="outline">
                <mat-label>Plan General</mat-label>
                <textarea
                  matInput
                  formControlName="plan"
                  placeholder="Plan general de manejo del paciente..."
                  rows="3"
                ></textarea>
              </mat-form-field>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Diagn贸stico -->
                <mat-form-field appearance="outline">
                  <mat-label>Diagn贸stico Principal</mat-label>
                  <textarea
                    matInput
                    formControlName="diagnosis"
                    placeholder="Diagn贸stico principal o impresi贸n diagn贸stica..."
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <!-- Diagn贸stico Diferencial -->
                <mat-form-field appearance="outline">
                  <mat-label>Diagn贸stico Diferencial</mat-label>
                  <textarea
                    matInput
                    formControlName="differentialDiagnosis"
                    placeholder="Posibles diagn贸sticos alternativos..."
                    rows="3"
                  ></textarea>
                </mat-form-field>
              </div>

              <!-- Plan de Tratamiento -->
              <mat-form-field appearance="outline">
                <mat-label>Plan de Tratamiento</mat-label>
                <textarea
                  matInput
                  formControlName="treatmentPlan"
                  placeholder="Medicamentos, procedimientos, terapias recomendadas..."
                  rows="4"
                ></textarea>
              </mat-form-field>

              <!-- Instrucciones de Seguimiento -->
              <mat-form-field appearance="outline">
                <mat-label>Instrucciones de Seguimiento</mat-label>
                <textarea
                  matInput
                  formControlName="followUpInstructions"
                  placeholder="Cu谩ndo regresar, signos de alarma, cuidados en casa..."
                  rows="3"
                ></textarea>
              </mat-form-field>

              <!-- Educaci贸n al Paciente -->
              <mat-form-field appearance="outline">
                <mat-label>Educaci贸n al Paciente</mat-label>
                <textarea
                  matInput
                  formControlName="patientEducation"
                  placeholder="Informaci贸n proporcionada al paciente sobre su condici贸n..."
                  rows="3"
                ></textarea>
              </mat-form-field>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Notas Adicionales -->
                <mat-form-field appearance="outline">
                  <mat-label>Notas Adicionales</mat-label>
                  <textarea
                    matInput
                    formControlName="notes"
                    placeholder="Observaciones adicionales..."
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <!-- Fecha de Seguimiento -->
                <mat-form-field appearance="outline">
                  <mat-label>Pr贸xima Cita de Seguimiento</mat-label>
                  <input matInput [matDatepicker]="followUpPicker" formControlName="followUpDate" />
                  <mat-datepicker-toggle matSuffix [for]="followUpPicker"></mat-datepicker-toggle>
                  <mat-datepicker #followUpPicker></mat-datepicker>
                </mat-form-field>
              </div>
            </div>

            <!-- Ejemplos para Evaluaci贸n -->
            <div class="mt-6 p-4 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
              <h3 class="text-sm font-bold text-indigo-800 mb-2">
                 Ejemplos de Evaluaci贸n y Plan:
              </h3>
              <div class="text-xs text-indigo-700 space-y-1">
                <div><strong>Diagn贸stico:</strong> "Apendicitis aguda, probable"</div>
                <div>
                  <strong>Plan:</strong> "1. Interconsulta con cirug铆a general, 2. Laboratorios
                  (hemograma, PCR), 3. TAC abdominal"
                </div>
                <div>
                  <strong>Tratamiento:</strong> "Analgesia con Metamizol 500mg IV c/8h, ayuno,
                  hidrataci贸n IV"
                </div>
                <div>
                  <strong>Seguimiento:</strong> "Evaluar en 6 horas o antes si empeoramiento del
                  dolor"
                </div>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button mat-stroked-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Anterior
            </button>
            <div class="flex gap-2">
              <button mat-stroked-button (click)="saveDraft()" type="button" color="accent">
                <mat-icon>save</mat-icon>
                Guardar Borrador
              </button>
              <button mat-flat-button color="primary" matStepperNext>
                Siguiente
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </div>
        </form>
      </mat-step>

      <!-- Paso 6: Formulario de Consentimiento -->
      <mat-step [stepControl]="consentForm" label="Formulario de Consentimiento">
        <form [formGroup]="consentForm">
          <div class="bg-white p-8 rounded-2xl shadow-lg border border-blue-100 mb-6">
            <h2 class="text-2xl font-bold text-blue-900 mb-6 flex items-center gap-3">
              <mat-icon class="text-blue-600">gavel</mat-icon>
              Formulario de Consentimiento Informado
            </h2>

            <div class="grid grid-cols-1 gap-6">
              <!-- Tipo de Consentimiento -->
              <mat-form-field appearance="outline">
                <mat-label>Tipo de Consentimiento</mat-label>
                <mat-select formControlName="consentType" required>
                  <mat-option *ngFor="let type of consentTypes" [value]="type">
                    {{ getConsentTypeText(type) }}
                  </mat-option>
                </mat-select>
                <mat-icon matSuffix>assignment_turned_in</mat-icon>
                <mat-error *ngIf="consentForm.get('consentType')?.hasError('required')">
                  Debe seleccionar el tipo de consentimiento
                </mat-error>
              </mat-form-field>

              <!-- Descripci贸n del Consentimiento -->
              <mat-form-field appearance="outline">
                <mat-label>Descripci贸n del Consentimiento</mat-label>
                <textarea
                  matInput
                  formControlName="description"
                  placeholder="Describa los procedimientos, riesgos y beneficios explicados al paciente..."
                  rows="6"
                  required
                ></textarea>
                <mat-error *ngIf="consentForm.get('description')?.hasError('required')">
                  La descripci贸n del consentimiento es requerida
                </mat-error>
                <mat-error *ngIf="consentForm.get('description')?.hasError('minlength')">
                  Debe proporcionar una descripci贸n m谩s detallada (m铆nimo 20 caracteres)
                </mat-error>
              </mat-form-field>

              <!-- Firmado por -->
              <mat-form-field appearance="outline">
                <mat-label>Firmado por (opcional)</mat-label>
                <input
                  matInput
                  formControlName="signedBy"
                  placeholder="Nombre de quien firma (paciente, tutor legal, etc.)"
                />
                <mat-icon matSuffix>person</mat-icon>
              </mat-form-field>

              <!-- Subida de Archivo -->
              <div
                class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors"
              >
                <mat-icon class="text-6xl text-gray-400 mb-4">cloud_upload</mat-icon>
                <h3 class="text-lg font-medium text-gray-900 mb-2">
                  Subir Documento de Consentimiento
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                  Seleccione el archivo firmado del consentimiento informado (PDF, JPG, PNG)
                </p>

                <input
                  type="file"
                  #fileInput
                  (change)="onFileSelected($event)"
                  accept=".pdf,.jpg,.jpeg,.png"
                  class="hidden"
                />

                <button mat-flat-button color="primary" type="button" (click)="fileInput.click()">
                  <mat-icon>attach_file</mat-icon>
                  Seleccionar Archivo
                </button>

                <!-- Archivo Seleccionado -->
                <div
                  *ngIf="selectedFile"
                  class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200"
                >
                  <div class="flex items-center justify-center gap-2">
                    <mat-icon class="text-green-600">check_circle</mat-icon>
                    <span class="text-green-800 font-medium">{{ selectedFile.name }}</span>
                    <span class="text-green-600 text-sm"
                      >({{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB)</span
                    >
                  </div>

                  <!-- Preview de imagen -->
                  <div *ngIf="filePreview" class="mt-3">
                    <img
                      [src]="filePreview"
                      alt="Preview"
                      class="max-w-xs max-h-48 mx-auto rounded-lg shadow-md"
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- Ejemplos para Consentimiento -->
            <div class="mt-6 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
              <h3 class="text-sm font-bold text-yellow-800 mb-2"> Ejemplo de Consentimiento:</h3>
              <div class="text-xs text-yellow-700 space-y-1">
                <div><strong>Tipo:</strong> Tratamiento General</div>
                <div>
                  <strong>Descripci贸n:</strong> "Se le ha explicado al paciente la naturaleza de su
                  condici贸n (apendicitis aguda), los riesgos y beneficios del tratamiento quir煤rgico
                  propuesto (apendicectom铆a laparosc贸pica), las alternativas disponibles y las
                  consecuencias de no recibir tratamiento. El paciente ha tenido la oportunidad de
                  hacer preguntas y ha expresado su comprensi贸n y consentimiento para el
                  procedimiento."
                </div>
                <div>
                  <strong>Firmado por:</strong> "Juan P茅rez (paciente)" o "Mar铆a P茅rez (madre,
                  tutora legal)"
                </div>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button mat-stroked-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Anterior
            </button>
            <div class="flex gap-4">
              <button mat-stroked-button (click)="saveDraft()" type="button" color="accent">
                <mat-icon>save</mat-icon>
                Guardar Borrador
              </button>
              <button
                mat-flat-button
                color="accent"
                (click)="onSubmit()"
                [disabled]="isSaving"
                type="button"
              >
                <mat-icon>save</mat-icon>
                {{
                  isSaving
                    ? 'Guardando...'
                    : isEditMode
                      ? 'Actualizar Expediente'
                      : 'Crear Expediente Completo'
                }}
              </button>
            </div>
          </div>
        </form>
      </mat-step>
    </mat-stepper>

    <!-- Botones de Acci贸n Flotantes -->
    <div class="fixed bottom-6 right-6 flex flex-col gap-3" *ngIf="!isLoading">
      <button mat-fab color="warn" (click)="cancel()" matTooltip="Cancelar">
        <mat-icon>close</mat-icon>
      </button>

      <button
        mat-fab
        color="accent"
        (click)="saveDraft()"
        matTooltip="Guardar Borrador"
        [disabled]="isSaving"
      >
        <mat-icon>save</mat-icon>
      </button>
    </div>
  </div>
</div>
